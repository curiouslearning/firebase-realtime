<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time User Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map {
            height: 100vh;
        }

        /* Pulsating circle animation */
        .pulse-circle {
            background-color: rgba(255, 0, 0, 0.4);
            border-radius: 50%;
            animation: pulsate 1.5s ease-out infinite;
        }

        @keyframes pulsate {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(2);
                opacity: 0.5;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([0, 0], 2); // Initialize map

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); // Add OpenStreetMap tile layer

        // Function to aggregate data by country
        function aggregateByCountry(data) {
            const countryData = {};

            data.forEach(user => {
                if (user.country && user.latitude && user.longitude && !isNaN(parseInt(user.active_users))) {
                    const country = user.country;
                    const activeUsers = parseInt(user.active_users);

                    // Aggregate by country
                    if (!countryData[country]) {
                        countryData[country] = {
                            active_users: activeUsers,
                            latitude: user.latitude,
                            longitude: user.longitude,
                        };
                    } else {
                        countryData[country].active_users += activeUsers;
                    }
                }
            });

            return Object.values(countryData);
        }

        // Function to fetch real-time data
        function fetchRealtimeData() {
            fetch('/realtime')
                .then(response => response.json())
                .then(data => {
                    // Clear existing markers
                    map.eachLayer(function (layer) {
                        if (layer instanceof L.Circle || layer instanceof L.Marker) {
                            map.removeLayer(layer);
                        }
                    });

                    // Aggregate data by country
                    const aggregatedData = aggregateByCountry(data);

                    // Add new markers and circles based on country
                    aggregatedData.forEach(country => {
                        const lat = country.latitude;
                        const lng = country.longitude;
                        const activeUsers = country.active_users;

                        // Add the circle with appropriate scaling
                        const circleRadius = Math.max(20000, activeUsers * 500); // Adjust minimum and scaling for circles
                        const circle = L.circle([lat, lng], {
                            radius: circleRadius, // Radius is based on aggregated active_users
                            color: 'red',
                            fillOpacity: 0.5,
                        }).addTo(map);

                        // Add pulsating marker with dynamic size
                        const iconSize = Math.max(20, activeUsers * 5); // Adjust icon scaling for pulse effect
                        const icon = L.divIcon({
                            className: 'pulse-circle',
                            iconSize: [iconSize, iconSize],
                            popupAnchor: [0, -iconSize / 2],
                        });

                        L.marker([lat, lng], { icon }).addTo(map);
                    });
                });
        }

        // Fetch data every 5 seconds
        setInterval(fetchRealtimeData, 5000);
    </script>
</body>

</html>