<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-Time User Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
#map {
    height: 100vh;
}

.pulse-circle {
    width: 10px; /* Default size */
    height: 10px; /* Default size */
    background-color: rgba(255, 0, 0, 0.4);
    border-radius: 50%;
    animation: pulsate 1.5s ease-out infinite;
    opacity: 1;
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* Center the circle in the div */
}

.transparent-div {
    background: none !important;
    border: none !important;
}

@keyframes pulsate {
    0% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.7;
    }

    50% {
        transform: translate(-50%, -50%) scale(2.5); /* Pulsing effect */
        opacity: 0.3;
    }

    100% {
        transform: translate(-50%, -50%) scale(1);
        opacity: 0.7;
    }
}


  </style>
</head>

<body>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([0, 0], 2); // Initialize map

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map); // Add OpenStreetMap tile layer

        // Function to aggregate data by country
        function aggregateByCountry(data) {
            const countryData = {};

            data.forEach(user => {
                if (user.country && user.latitude && user.longitude && !isNaN(parseInt(user.active_users))) {
                    const country = user.country;
                    const activeUsers = parseInt(user.active_users);

                    // Aggregate by country
                    if (!countryData[country]) {
                        countryData[country] = {
                            active_users: activeUsers,
                            latitude: user.latitude,
                            longitude: user.longitude,
                        };
                    } else {
                        countryData[country].active_users += activeUsers;
                    }
                }
            });

            return Object.values(countryData);
        }

    // Function to fetch real-time data
    function fetchRealtimeData() {
        fetch('/realtime')
            .then(response => response.json())
            .then(data => {
                // Clear existing markers
                map.eachLayer(function (layer) {
                    if (layer instanceof L.Circle || layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });

                // Aggregate data by country
                const aggregatedData = aggregateByCountry(data);

                // Add new markers and circles based on country
                aggregatedData.forEach(country => {
                    const lat = country.latitude;
                    const lng = country.longitude;
                    const activeUsers = country.active_users;

                    // Add the circle with appropriate scaling
                    if (lat !== 0 && lng !== 0 && !isNaN(lat) && !isNaN(lng)) {
                        const circleRadius = Math.max(10000, activeUsers * 500); // Adjust circle radius as needed
                        const circle = L.circle([lat, lng], {
                            radius: circleRadius,
                            color: 'red',
                            fillOpacity: 0.5,
                        }).addTo(map);

                        const circleSize = Math.max(20, activeUsers * 10); // Adjust pulsating circle size

                        const icon = L.divIcon({
                            html: `<div class="pulse-circle" style="width: ${circleSize}px; height: ${circleSize}px;"></div>`, // Inject dynamic size
                            iconSize: [circleSize, circleSize],  // Set the icon size to match the circle
                            className: 'transparent-div', // Make sure the div itself has no style
                            popupAnchor: [0, -circleSize / 2],   // Center the popup
                        });

                        L.marker([lat, lng], { icon }).addTo(map);
                    }
                });
            });
    }

    // Fetch data every 60 seconds
    setInterval(fetchRealtimeData, 60000);

    </script>
</body>

</html>